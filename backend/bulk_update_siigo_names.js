require('dotenv').config();
const axios = require('axios');
const path = require('path');
// Import siigoService logic/config directly or use independent logic. 
// For a standalone script, using siigoService is better if available, but I'll write self-contained logic for robustness and specific logging.
const siigoService = require('./services/siigoService');

const nitsToProcess = [
    '1000184065', '1000236521', '1000257107', '1000733322', '1000857985', '1000931429', '1001308984', '1002649646', '1002726980', '1003534098', '1004082955', '1006023950', '1007106893', '1007723568', '1010204063', '1010232092', '1010239949', '1012327658', '1012348870', '1012352727', '1012385697', '1013097160', '1013586380', '1014205533', '1014252909', '1014307537', '1014856223', '1015402129', '1016016908', '1016029572', '1016074368', '1019027996', '1019067741', '1019079910', '1019102045', '1019110212', '1020839575', '1022330987', '1023008012', '102364424', '1023878232', '1024525720', '1024591752', '1026307045', '1026559375', '1026586400', '1029860621', '1030547580', '1030590993', '1030618232', '1030682599', '1031141854', '1031152080', '1031152317', '1031157508', '1031164848', '1031655089', '1032407335', '1039450814', '1045018449', '1047511526', '1050672135', '1052358769', '1053345205', '1053765139', '1054709556', '1056028898', '1061735662', '1065852669', '1070968112', '1071062531', '1071165368', '1072189770', '1072426902', '1072749542', '1073176082', '1075669659', '1075872822', '1076664888', '1077968669', '1078369912', '1083870428', '1087410729', '1096951350', '1098407302', '1113314274', '1114062864', '1118198057', '1118549443', '1118555153', '1121821853', '1121965900', '1123205411', '1125230591', '1126121464', '11348513', '11367165', '1144061953', '11450761', '12196432', '1233506432', '1233889513', '1234788797', '14135627', '15447675', '178968', '197288823', '20451065', '26524996', '26987196', '27105664', '276018415', '28142581', '3005971370', '3063223', '3087686', '3134268164', '3134440220', '3212273441', '354255612', '36068862', '39583772', '39667295', '40771241', '42164558', '46666538', '46669983', '51851928', '51913742', '52073759', '52122151', '52164728', '523128455', '52385038', '52776170', '52779975', '52803346', '52843695', '52959012', '52960363', '52961473', '52968336', '52974455', '53054040', '53071770', '53088147', '53134515', '53893837', '5844191', '63501252', '64871287', '65763572', '68306060', '700107122', '700183994', '700259475', '700429536', '7178040', '79063899', '79150932', '79216334', '79295842', '79435565', '79467408', '79528621', '79536540', '79536582', '79540727', '79714122', '79814401', '79914236', '79996875', '800003122', '800016635', '800018771', '800023789', '80002467', '800037800', '800042471', '800059758', '800064784', '800088702', '800095036', '800097913', '800112806', '800118954', '800130907', '800138188', '800140949', '800147502', '800148514', '800149496', '800153993', '800158191', '800176192', '800180832', '800185306', '800197268', '800211025', '800213075', '800216278', '800219488', '800224808', '800224827', '800226061', '800226175', '800227940', '800229739', '800231969', '800240470', '800242106', '800247438', '800249241', '800251440', '800251569', '800253055', '800256161', '80147990', '80188095', '80193203', '80236073', '80247130', '80250059', '804002105', '804008684', '80409739', '80438923', '805000427', '805001157', '805021170', '806008394', '807004756', '80731923', '80732038', '80842757', '809008362', '80932931', '811001897', '811004055', '811009788', '811023661', '811033006', '813006146', '813011257', '814000337', '817001773', '818000140', '824001398', '830003564', '830005293', '830008686', '830009783', '830012859', '830017656', '830028647', '830029480', '830029703', '830035186', '830037248', '830037946', '830038515', '830039295', '830039304', '830040184', '830041488', '830044783', '830047979', '830048145', '830049499', '830053699', '830054539', '830054904', '830055803', '830058798', '830062113', '830071625', '830074184', '830074184', '830076099', '830077541', '830077886', '830078512', '830080391', '830082972', '830084339', '830096897', '830100896', '830109677', '830113831', '830115369', '830116721', '830122566', '830125132', '830129394', '830137645', '830139432', '830140098', '830145818', '830146812', '83044885', '830501181', '830512130', '830512762', '830513729', '832000760', '837000084', '839000495', '844003392', '860001386', '860001584', '860002183', '860002464', '860002503', '860002964', '860003020', '860006754', '860006800', '860006866', '860007322', '860007335', '860007336', '860007379', '860007647', '860007738', '860007760', '860008645', '860010305', '860011153', '86001284', '860013570', '860013873', '8600203706', '860022137', '860025461', '860027404', '860034313', '860034594', '860035827', '860040558', '860045904', '860049042', '860050750', '860051135', '860052155', '860061403', '860066942', '860078674', '860090331', '860090439', '860325638', '860351712', '860451763', '860500480', '860503159', '860503617', '860504882', '860507000', '860511704', '860512330', '860524654', '860524896', '86074547', '88033653', '890000381', '890101994', '890102002', '890102044', '890102257', '890200106', '890200756', '890201578', '890203088', '890203183', '890270275', '890300279', '890300625', '890303093', '890303208', '890317339', '890399010', '890480023', '890480110', '890480123', '890500516', '890500675', '890700148', '890704737', '890806490', '890900098', '890900496', '890900608', '890900840', '890900841', '890900842', '890900943', '890903407', '890903790', '890903937', '890903938', '890904996', '890912221', '890929877', '890980040', '891080005', '891080031', '891180008', '891190047', '891200337', '891280008', '891480000', '891500182', '891500319', '891600091', '891780093', '891800213', '891800330', '891856000', '892000146', '892115006', '892200015', '892399989', '892400320', '899999001', '899999034', '899999061', '899999063', '899999107', '899999143', '899999239', '899999284', '899999734', '900009234', '900029126', '900029295', '900035973', '900041762', '900041883', '900057203', '900061113', '900069128', '900072047', '900076393', '900078103', '900097333', '900097604', '900104069', '900125280', '900132921', '900147238', '900148264', '900151590', '900155107', '900156264', '900156645', '900166840', '900187583', '900189148', '900195490', '900200960', '900201094', '900209702', '900211839', '900213759', '900226169', '900226715', '900235110', '900235157', '900245292', '900250321', '900269840', '900275698', '900279810', '900295299', '900296993', '900298372', '900302016', '900305364', '900305585', '900319291', '900319753', '900328866', '900336004', '900336875', '900339402', '900339729', '900348668', '900349815', '900350970', '900353761', '9003537616', '9003580306', '900359325', '900360329', '900367677', '900369233', '900371896', '900375454', '900381065', '900392157', '900396458', '900397034', '900406150', '900409147', '900409224', '900411469', '900415647', '900428982', '900429986', '900431901', '900436352', '900439056', '900441849', '900446887', '900447069', '900448552', '900452222', '900460577', '900461787', '900463851', '900471761', '900472986', '900474769', '900475562', '900479174', '900480569', '900487605', '900489109', '900491669', '900497351', '900504473', '900510587', '900510617', '900514605', '900519621', '900520221', '900522746', '900527370', '900531347', '900534936', '900538030', '900539463', '900547905', '900554707', '900562607', '900577860', '900585639', '900604350', '900609714', '900610404', '900613051', '900616984', '900617580', '900622540', '900627278', '900628110', '900631320', '900633094', '900646826', '900646969', '900656514', '900658143', '900668302', '900679829', '900688349', '900689812', '900694108', '900705294', '900711396', '900712330', '900713058', '900714066', '900715490', '900717866', '900724242', '900731313', '900744732', '900749220', '900752922', '900763278', '900778577', '900797786', '900811948', '900833423', '900834225', '900836624', '900840831', '900843190', '900844231', '900845437', '900867817', '900867989', '900871444', '900873597', '900901377', '900907080', '900914254', '900919742', '900923299', '900930524', '900933344', '900935126', '900935615', '900943243', '900945604', '900948650', '900957526', '900967564', '900968238', '900968239', '900968369', '900979649', '900980710', '900981222', '900983525', '900984196', '900985182', '900988920', '900993002', '900995505', '901003617', '901004464', '901004932', '901005268', '901007055', '901009488', '901024751', '901025452', '901028018', '901030721', '901037916', '901037916', '901037916', '901038026', '9010406403', '901048484', '901051655', '901056907', '901060819', '901067990', '901069126', '901070649', '901082504', '901086334', '901088695', '901092086', '901093846', '901097473', '901097473', '901101560', '9011018777', '901106763', '901118095', '901119988', '901120633', '901131093', '901139104', '901139761', '901143055', '901143367', '901147181', '901147197', '901149588', '901149639', '901150055', '901152703', '901154414', '901161472', '901161697', '9011710135', '901175445', '901176120', '901176466', '901178064', '901178162', '901180021', '901180695', '901182095', '901185191', '901188493', '901191345', '901195288', '901199115', '901200178', '901204486', '901208109', '901211757', '901211771', '901217214', '901218501', '901221433', '901223505', '901223534', '901224228', '901231054', '901231176', '901231781', '901234292', '901243245', '901243912', '901248393', '901253254', '901255401', '901259148', '901262720', '901265652', '901265947', '901268737', '901269734', '901271775', '901274172', '901275135', '901275296', '901278334', '901287817', '901290527', '901296898', '901298813', '901301296', '901302358', '9013029245', '901304856', '901313766', '901322042', '901322449', '901325363', '901326511', '901331844', '901334466', '901335552', '901337581', '901342177', '901348293', '901350283', '901357413', '901361052', '901361199', '901363874', '901365841', '901366964', '901371747', '901373610', '901374195', '901382949', '901386832', '901389424', '901391122', '901392133', '901396473', '901409191', '901409753', '901416220', '901423928', '901425305', '901433016', '901435866', '901436584', '90143821', '901438859', '901439056', '901447585', '901448512', '901451488', '901455856', '901457904', '901458312', '901459096', '901460418', '901465010', '901468413', '901469580', '901475929', '90147772', '901481747', '901483197', '901485351', '901486493', '901488045', '901488237', '901488796', '901489698', '901494799', '901498327', '901501954', '901503722', '901504950', '901506600', '901511845', '901513125', '901516738', '901517529', '901517783', '901517784', '901518659', '901521369', '90152222', '901524090', '901524286', '901527646', '901532992', '901533464', '901533846', '901533963', '901534368', '901536048', '901538156', '901538750', '901539424', '901541479', '901541521', '901543761', '90154634', '901546394', '901549352', '901555566', '901559949', '901564613', '901565609', '901565887', '901565945', '901568800', '901569530', '901571782', '90157399', '901574363', '901574364', '901577693', '901578646', '901578691', '901582268', '901585217', '901585988', '901587865', '901590811', '901593916', '901595031', '901595355', '901596923', '901603724', '901607372', '901614682', '9016168317', '901618492', '901619397', '901620405', '901621021', '901623388', '901626321', '901628585', '901629386', '901629510', '901629814', '901629832', '901631602', '90163551', '901636725', '901637728', '901641442', '9016422674', '901643458', '901644169', '901660306', '901668425', '901669845', '901671909', '901676626', '901677383', '901683125', '901687494', '901690915', '901691199', '901692210', '901694959', '901696780', '901697345', '901702639', '901703555', '901705944', '901706539', '901706893', '901707787', '901709209', '901712114', '901713591', '901717662', '901718496', '901719289', '901719729', '901730388', '901733167', '901733278', '901734893', '901736897', '901737552', '901738221', '901739707', '901740750', '901744358', '901745374', '9017483558', '901748358', '901749888', '901750766', '901755502', '901755642', '901757430', '901757861', '901759962', '901760218', '901762538', '901764504', '901767347', '901768453', '901776318', '901779099', '901791172', '901791740', '901794315', '901796065', '901798858', '901798966', '901800654', '901800949', '901803222', '901806094', '901810634', '901811271', '901813095', '901813232', '901813319', '901815496', '901815516', '901817531', '901818814', '901820389', '901820420', '901823834', '901824434', '9018250475', '901825976', '901826296', '901827203', '901827485', '901832879', '901840378', '901840733', '901842613', '901843592', '901845726', '901845899', '901845925', '901848368', '901848512', '901849971', '901850125', '90185026', '901850264', '901852991', '901853632', '901854687', '901859450', '901859740', '901862409', '901863669', '901864328', '901864445', '901865115', '901866024', '901870699', '901874854', '901878434', '901878966', '901880274', '901881758', '901891237', '901899771', '901902359', '901902684', '901905770', '901906924', '901908873', '901911557', '901913023', '901913227', '901918405', '901918888', '901921944', '901923972', '901928828', '901928833', '901930100', '901930367', '9019336406', '901936293', '901947185', '901951915', '901953630', '9019564731', '901963004', '901963187', '901970350', '901975045', '901977404', '901980052', '901980127', '901997808', '902001914', '902003662', '902016898', '90361830', '909411469', '910728431', '91532545', '9285408', '93380886', '999999'
];

async function updateSiigoCustomer(customerId, currentData, baseURL, headers) {
    try {
        const payload = { ...currentData };
        delete payload.metadata;
        delete payload.id;
        delete payload.created_at;

        // Logic check: if commercial_name is empty, use name[0]
        const hasCommercialName = payload.commercial_name && payload.commercial_name.trim() !== '' && payload.commercial_name !== 'No aplica';

        if (!hasCommercialName) {
            let newName = '';
            if (Array.isArray(payload.name) && payload.name.length > 0) {
                newName = payload.name[0];
            } else if (typeof payload.name === 'string') {
                newName = payload.name;
            }

            if (newName) {
                payload.commercial_name = newName;
            } else {
                console.log(`âš ï¸ Customer ${currentData.identification} has no name source for commercial_name. Skipping update.`);
                return false;
            }
        } else {
            console.log(`â„¹ï¸ Customer ${currentData.identification} already has commercial_name: "${payload.commercial_name}". Skipping update.`);
            return false;
        }

        // FIX: id_type flat structure check
        if (payload.id_type && typeof payload.id_type === 'object' && payload.id_type.code) {
            payload.id_type = payload.id_type.code;
        }

        // PUT request
        await axios.put(`${baseURL}/v1/customers/${customerId}`, payload, { headers });
        console.log(`âœ… Customer ${currentData.identification} updated with commercial_name: "${payload.commercial_name}"`);
        return true;

    } catch (e) {
        console.error(`âŒ Error updating customer ${currentData.identification}:`, e.message);
        if (e.response?.data) console.error(JSON.stringify(e.response.data));
        return false;
    }
}

async function bulkProcess() {
    try {
        console.log('Authenticating...');
        await siigoService.loadConfig();
        const headers = await siigoService.getHeaders();
        const baseURL = siigoService.baseURL || 'https://api.siigo.com';

        let processedCount = 0;
        let updatedCount = 0;
        let errorsCount = 0;

        for (const nit of nitsToProcess) {
            processedCount++;
            console.log(`\n[${processedCount}/${nitsToProcess.length}] Processing NIT: ${nit}...`);

            try {
                // Rate limiting wait (preventive)
                await new Promise(r => setTimeout(r, 500));

                // 1. Get Customer by NIT
                // Note: /v1/customers?identification=NIT returns a list results: []
                const res = await axios.get(`${baseURL}/v1/customers?identification=${nit}`, { headers });

                if (res.data && res.data.results && res.data.results.length > 0) {
                    const customer = res.data.results[0];
                    const updated = await updateSiigoCustomer(customer.id, customer, baseURL, headers);
                    if (updated) updatedCount++;
                } else {
                    console.log(`âš ï¸ NIT ${nit} not found in SIIGO.`);
                    errorsCount++;
                }

            } catch (error) {
                console.error(`âŒ Fatal error processing NIT ${nit}:`, error.message);
                if (error.response?.status === 429) {
                    console.log('ðŸš¦ Rate Limit hit. Waiting 5 seconds...');
                    await new Promise(r => setTimeout(r, 5000));
                    // Simple retry logic could be added here, but for now we continue
                }
                errorsCount++;
            }
        }

        console.log('\n--- SUMMARY ---');
        console.log(`Total Processed: ${processedCount}`);
        console.log(`Updated: ${updatedCount}`);
        console.log(`Errors/Not Found: ${errorsCount}`);
        process.exit(0);

    } catch (e) {
        console.error('Script Loop Error:', e);
        process.exit(1);
    }
}

bulkProcess();
